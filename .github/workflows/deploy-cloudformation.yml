name: Deploy to AWS CloudFormation

on:
  workflow_dispatch:
    inputs:
      stack-name:
        description: 'CloudFormation stack name'
        required: true
        default: 'bell-streaming'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - update
          - delete
        default: 'update'
      instance-type:
        description: 'EC2 Instance Type'
        required: false
        default: 't3.2xlarge'
      region:
        description: 'AWS Region'
        required: false
        default: 'us-east-1'

env:
  AWS_REGION: ${{ github.event.inputs.region || 'us-east-1' }}
  TEMPLATES_BUCKET: bell-streaming-cfn-templates

jobs:
  upload-templates:
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'delete'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 bucket for templates if not exists
        run: |
          if ! aws s3 ls "s3://${TEMPLATES_BUCKET}" 2>&1 | grep -q 'NoSuchBucket'; then
            echo "Bucket already exists"
          else
            aws s3 mb "s3://${TEMPLATES_BUCKET}" --region ${{ env.AWS_REGION }}
            echo "Bucket created"
          fi

      - name: Upload CloudFormation templates to S3
        run: |
          aws s3 sync infra/cloudformation/ s3://${TEMPLATES_BUCKET}/cloudformation/ \
            --exclude "README.md" \
            --exclude "parameters.yml"
          echo "✅ Templates uploaded to S3"

  deploy-stack:
    needs: upload-templates
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'delete'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks --stack-name ${{ github.event.inputs.stack-name }} --region ${{ env.AWS_REGION }} 2>&1 | grep -q 'does not exist'; then
            echo "exists=false" >> $GITHUB_OUTPUT
          else
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Create CloudFormation stack
        if: github.event.inputs.action == 'create' && steps.check-stack.outputs.exists == 'false'
        run: |
          aws cloudformation create-stack \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --template-body file://infra/cloudformation/main.yml \
            --capabilities CAPABILITY_IAM \
            --parameters \
              ParameterKey=KeyName,ParameterValue=${{ secrets.EC2_KEY_NAME }} \
              ParameterKey=InstanceType,ParameterValue=${{ github.event.inputs.instance-type }} \
              ParameterKey=MongoDbUri,ParameterValue=${{ secrets.MONGODB_URI }} \
              ParameterKey=JwtSecret,ParameterValue=${{ secrets.JWT_SECRET }} \
              ParameterKey=JwtRefreshSecret,ParameterValue=${{ secrets.JWT_REFRESH_SECRET }} \
              ParameterKey=AwsAccessKeyId,ParameterValue=${{ secrets.AWS_S3_ACCESS_KEY_ID }} \
              ParameterKey=AwsSecretAccessKey,ParameterValue=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }} \
              ParameterKey=S3BucketName,ParameterValue=${{ secrets.S3_BUCKET_NAME }} \
              ParameterKey=FreepikApiKey,ParameterValue=${{ secrets.FREEPIK_API_KEY }} \
              ParameterKey=WebhookUrl,ParameterValue=${{ secrets.WEBHOOK_URL }} \
              ParameterKey=TemplatesBucketName,ParameterValue=${TEMPLATES_BUCKET} \
            --region ${{ env.AWS_REGION }}
          
          echo "⏳ Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "✅ Stack created successfully"

      - name: Update CloudFormation stack
        if: github.event.inputs.action == 'update' && steps.check-stack.outputs.exists == 'true'
        run: |
          aws cloudformation update-stack \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --template-body file://infra/cloudformation/main.yml \
            --capabilities CAPABILITY_IAM \
            --parameters \
              ParameterKey=KeyName,ParameterValue=${{ secrets.EC2_KEY_NAME }} \
              ParameterKey=InstanceType,ParameterValue=${{ github.event.inputs.instance-type }} \
              ParameterKey=MongoDbUri,ParameterValue=${{ secrets.MONGODB_URI }} \
              ParameterKey=JwtSecret,ParameterValue=${{ secrets.JWT_SECRET }} \
              ParameterKey=JwtRefreshSecret,ParameterValue=${{ secrets.JWT_REFRESH_SECRET }} \
              ParameterKey=AwsAccessKeyId,ParameterValue=${{ secrets.AWS_S3_ACCESS_KEY_ID }} \
              ParameterKey=AwsSecretAccessKey,ParameterValue=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }} \
              ParameterKey=S3BucketName,ParameterValue=${{ secrets.S3_BUCKET_NAME }} \
              ParameterKey=FreepikApiKey,ParameterValue=${{ secrets.FREEPIK_API_KEY }} \
              ParameterKey=WebhookUrl,ParameterValue=${{ secrets.WEBHOOK_URL }} \
              ParameterKey=TemplatesBucketName,ParameterValue=${TEMPLATES_BUCKET} \
            --region ${{ env.AWS_REGION }} || echo "No updates to perform"
          
          echo "⏳ Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --region ${{ env.AWS_REGION }} || echo "Update completed or no changes"
          
          echo "✅ Stack updated successfully"

      - name: Get stack outputs
        if: github.event.inputs.action != 'delete'
        run: |
          echo "## CloudFormation Stack Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output json)
          
          echo "$OUTPUTS" | jq -r '.[] | "**\(.OutputKey):** \(.OutputValue)"' >> $GITHUB_STEP_SUMMARY

  delete-stack:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'delete'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete CloudFormation stack
        run: |
          aws cloudformation delete-stack \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "⏳ Waiting for stack deletion to complete..."
          aws cloudformation wait stack-delete-complete \
            --stack-name ${{ github.event.inputs.stack-name }} \
            --region ${{ env.AWS_REGION }}
          
          echo "✅ Stack deleted successfully"
